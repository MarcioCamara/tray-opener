{"version":3,"file":"onuncaughtexception.js","sourceRoot":"","sources":["../../../src/main/integrations/onuncaughtexception.ts"],"names":[],"mappings":";;AAAA,uCAAyD;AACzD,yCAA6D;AAC7D,uCAAkC;AAElC,+BAA+B;AAC/B,MAAa,mBAAmB;IAW9B;;OAEG;IACH,YACmB,WAGb,EAAE;QAHW,aAAQ,GAAR,QAAQ,CAGnB;QAjBR;;WAEG;QACI,SAAI,GAAW,mBAAmB,CAAC,EAAE,CAAC;IAe1C,CAAC;IAEJ;;OAEG;IACI,SAAS;QACd,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,mBAAmB,EAAE,CAAC,KAAY,EAAE,EAAE;YACtD,MAAM,IAAI,GAAG,oBAAa,EAAE,CAAC,cAAc,CAAC,mBAAmB,CAAC,CAAC;YACjE,IAAI,IAAI,EAAE;gBACR,oBAAa,EAAE,CAAC,SAAS,CAAC,CAAM,KAAK,EAAC,EAAE;oBACtC,KAAK,CAAC,iBAAiB,CAAC,CAAO,KAAY,EAAE,EAAE;wBAAC,OAAA,iCAC3C,KAAK,KACR,KAAK,EAAE,gBAAQ,CAAC,KAAK,IACrB,CAAA;sBAAA,CAAC,CAAC;oBAEJ,MAAM,UAAU,GAAG,oBAAa,EAAE,CAAC,SAAS,EAAgB,CAAC;oBAC7D,UAAU,CAAC,gBAAgB,CAAC,KAAK,EAAE,EAAE,iBAAiB,EAAE,KAAK,EAAE,EAAE,oBAAa,EAAE,CAAC,QAAQ,EAAE,CAAC,CAAC;oBAC7F,MAAM,UAAU,CAAC,KAAK,CAAC,UAAU,CAAC,UAAU,EAAE,CAAC,eAAe,IAAI,IAAI,CAAC,CAAC;oBAExE,IAAI,IAAI,CAAC,QAAQ,CAAC,YAAY,EAAE;wBAC9B,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;qBACnC;yBAAM,IAAI,MAAM,CAAC,OAAO,CAAC,aAAa,CAAC,mBAAmB,CAAC,IAAI,CAAC,EAAE;wBACjE,8DAA8D;wBAC9D,0DAA0D;wBAC1D,OAAO,CAAC,KAAK,CAAC,qBAAqB,CAAC,CAAC;wBACrC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;wBACrB,MAAM,GAAG,GAAG,KAAK,CAAC,KAAK,CAAC;wBACxB,MAAM,KAAK,GAAG,GAAG,KAAK,SAAS,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,IAAI,KAAK,KAAK,CAAC,OAAO,EAAE,CAAC;wBAC1E,MAAM,OAAO,GAAG,wBAAwB,KAAK,EAAE,CAAC;wBAChD,iBAAM,CAAC,YAAY,CAAC,iDAAiD,EAAE,OAAO,CAAC,CAAC;qBACjF;gBACH,CAAC,CAAA,CAAC,CAAC;aACJ;QACH,CAAC,CAAC,CAAC;IACL,CAAC;;AArDH,kDAsDC;AAhDC;;GAEG;AACW,sBAAE,GAAW,qBAAqB,CAAC","sourcesContent":["import { getCurrentHub, NodeClient } from '@sentry/node';\nimport { Event, Integration, Severity } from '@sentry/types';\nimport { dialog } from 'electron';\n\n/** Capture unhandled erros. */\nexport class OnUncaughtException implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public name: string = OnUncaughtException.id;\n\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'OnUncaughtException';\n\n  /**\n   * @inheritDoc\n   */\n  public constructor(\n    private readonly _options: {\n      /** Fatal Error callback */\n      onFatalError?(firstError: Error, secondError?: Error): void;\n    } = {},\n  ) {}\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(): void {\n    global.process.on('uncaughtException', (error: Error) => {\n      const self = getCurrentHub().getIntegration(OnUncaughtException);\n      if (self) {\n        getCurrentHub().withScope(async scope => {\n          scope.addEventProcessor(async (event: Event) => ({\n            ...event,\n            level: Severity.Fatal,\n          }));\n\n          const nodeClient = getCurrentHub().getClient() as NodeClient;\n          nodeClient.captureException(error, { originalException: error }, getCurrentHub().getScope());\n          await nodeClient.flush(nodeClient.getOptions().shutdownTimeout || 2000);\n\n          if (this._options.onFatalError) {\n            this._options.onFatalError(error);\n          } else if (global.process.listenerCount('uncaughtException') <= 2) {\n            // In addition to this handler there is always one in Electron\n            // The dialog is only shown if there are no other handlers\n            console.error('Uncaught Exception:');\n            console.error(error);\n            const ref = error.stack;\n            const stack = ref !== undefined ? ref : `${error.name}: ${error.message}`;\n            const message = `Uncaught Exception:\\n${stack}`;\n            dialog.showErrorBox('A JavaScript error occurred in the main process', message);\n          }\n        });\n      }\n    });\n  }\n}\n"]}